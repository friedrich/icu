<html>

<head>
<title>Transliteration Rule Editor</title>
<style type="text/css">
.wide    { width: 100% }
textarea { font-family: Arial Unicode MS; font-size: 100% }
</style>
</head>

<script>
// Determine our location.
if (location == "http://oss.software.ibm.com/developerworks/opensource/icu/translitdemo") {
  SELF = "/developerworks/opensource/icu/translitdemo";
  JS = "../icu/project/demo";
} else {
  SELF = "/cgi-bin/translit";
  JS = "../js";
}

// Load up the js/util.js script.  Unbelievably, this works.
document.writeln("\x3Cscript src=\"" + JS + "/util.js\"\x3E\x3C\x2Fscript\x3E");
</script>

<script>
NEW_ID = "(New Transliterator)";
SEPARATOR = "--------";
IS_NEW_ID = 0;

// We can get these dynamically from the CGI, but it's too slow.  Also,
// this allows us to eliminate ones we don't want, like
// UnicodeName-UnicodeChar.

AVAILABLE_RBT_IDS =
"Latin-Arabic;Arabic-Latin;Latin-Cyrillic;Cyrillic-Latin;Latin-Devanagari;Devanagari-Latin;Latin-Greek;Greek-Latin;Latin-Hebrew;Hebrew-Latin;Latin-Jamo;Jamo-Latin;Latin-Kana;Kana-Latin;CurlyQuotes-StraightQuotes;StraightQuotes-CurlyQuotes;Fullwidth-Halfwidth;Halfwidth-Fullwidth;Hiragana-Katakana;Katakana-Hiragana;KeyboardEscape-Latin1".split(";");

AVAILABLE_IDS = "Latin-Arabic;Arabic-Latin;Latin-Cyrillic;Cyrillic-Latin;Latin-Devanagari;Devanagari-Latin;Latin-Greek;Greek-Latin;Latin-Hangul;Hangul-Latin;Latin-Hebrew;Hebrew-Latin;Latin-Jamo;Jamo-Latin;Latin-Kana;Kana-Latin;Any-Lower;Any-Name;Name-Any;Any-Title;Any-Upper;Bengali-Devanagari;Devanagari-Bengali;Bengali-Gujarati;Gujarati-Bengali;Bengali-Gurmukhi;Gurmukhi-Bengali;Bengali-Kannada;Kannada-Bengali;Bengali-Malayalam;Malayalam-Bengali;Bengali-Oriya;Oriya-Bengali;Bengali-Tamil;Tamil-Bengali;Bengali-Telugu;Telugu-Bengali;CurlyQuotes-StraightQuotes;StraightQuotes-CurlyQuotes;Devanagari-Gujarati;Gujarati-Devanagari;Devanagari-Gurmukhi;Gurmukhi-Devanagari;Devanagari-Kannada;Kannada-Devanagari;Devanagari-Malayalam;Malayalam-Devanagari;Devanagari-Oriya;Oriya-Devanagari;Devanagari-Tamil;Tamil-Devanagari;Devanagari-Telugu;Telugu-Devanagari;Fullwidth-Halfwidth;Halfwidth-Fullwidth;Gujarati-Gurmukhi;Gurmukhi-Gujarati;Gujarati-Kannada;Kannada-Gujarati;Gujarati-Malayalam;Malayalam-Gujarati;Gujarati-Oriya;Oriya-Gujarati;Gujarati-Tamil;Tamil-Gujarati;Gujarati-Telugu;Telugu-Gujarati;Gurmukhi-Kannada;Kannada-Gurmukhi;Gurmukhi-Malayalam;Malayalam-Gurmukhi;Gurmukhi-Oriya;Oriya-Gurmukhi;Gurmukhi-Tamil;Tamil-Gurmukhi;Gurmukhi-Telugu;Telugu-Gurmukhi;Hangul-Jamo;Jamo-Hangul;Hex-Unicode;Unicode-Hex;Hiragana-Katakana;Katakana-Hiragana;Kannada-Malayalam;Malayalam-Kannada;Kannada-Oriya;Oriya-Kannada;Kannada-Tamil;Tamil-Kannada;Kannada-Telugu;Telugu-Kannada;KeyboardEscape-Latin1;Malayalam-Oriya;Oriya-Malayalam;Malayalam-Tamil;Tamil-Malayalam;Malayalam-Telugu;Telugu-Malayalam;Null;Oriya-Tamil;Tamil-Oriya;Oriya-Telugu;Telugu-Oriya;Remove;Tamil-Telugu;Telugu-Tamil;UnicodeName-UnicodeChar".split(";");

// Generate options (inline) for SELECT element
function generateSelectIDOptions() {
  var selection = document.FORM._SELECT_ID_SELECTION.value;
  //alert(document.FORM.ARG_OPERATION.value);
  var options = USER_IDS;
  if (document.FORM.ARG_OPERATION.value != "COMPILE" &&
      document.FORM.ARG_OPERATION.value != "_LOAD") {
    selection = NEW_ID;
    options = [NEW_ID].concat(options);
    IS_NEW_ID = 1;
  }
  options = options.concat([SEPARATOR]).concat(AVAILABLE_RBT_IDS);
  generateOptions(options, selection);
}

function handleSave() {
  var id = getSelectedOption(document.FORM.SELECT_ID);
  if (id == SEPARATOR) return;
  if (!id || id == NEW_ID) {
    handleSaveAs();
    return;
  }
  document.FORM.ARG_OPERATION.value = "COMPILE";
  document.FORM.ARG_ID.value = id;
  document.FORM.ARG_RULES.value = document.FORM.RULE_SOURCE.value;
  document.FORM.submit();
}

function isAValidID(id) {
  return id.match(/^[0-9A-Za-z]+$/) != null ||
         id.match(/^[0-9A-Za-z]+-[0-9A-Za-z]+$/) != null;
}

function handleSaveAs() {
  // Loop until user enters a valid ID or cancels
  for (;;) {
    var id = prompt("Save this rule set as:", "");
    if (id == null) return;
    id = trimSpaces(id, 1);
    if (!isAValidID(id)) {
      alert("Please supply an ID of the form AAA or AAA-AAA,\nwhere AAA is one or more alphanumeric characters.");
      continue;
    }
    if (arrayContainsString(USER_IDS, id, 1)) {
      if (confirm("Replace existing rule set " + id + "?")) {
        break;
      } else {
        continue;
      }
    }
    if (arrayContainsString(AVAILABLE_IDS, id, 1)) {
      alert(id + " is a system transliterator.  Please choose a different ID.");
      continue;
    }
    break; // Got a valid ID.
  }
  document.FORM.ARG_OPERATION.value = "COMPILE";
  document.FORM.ARG_ID.value = id;
  document.FORM.ARG_RULES.value = document.FORM.RULE_SOURCE.value;
  document.FORM._SELECT_ID_SELECTION.value = id;
  document.FORM._USER_IDS_CHANGED.value = 1;
  document.FORM.submit();
}

function handleDelete() {
  var id = getSelectedOption(document.FORM.SELECT_ID);
  if (id == SEPARATOR) return;
  if (id == NEW_ID) return;
  if (confirm("Delete " + id + "?")) {
    document.FORM.ARG_OPERATION.value = "REMOVE";
    document.FORM.ARG_ID.value = id;
    document.FORM._USER_IDS_CHANGED.value = 1;
    document.FORM.submit();
  }
}

function handleSelectID() {
  var id = getSelectedOption(document.FORM.SELECT_ID);
  if (id == SEPARATOR) return;
  if (id == NEW_ID) return;
  // _LOAD is not recognized by the cgi, but we use it
  document.FORM.ARG_OPERATION.value = "_LOAD";
  document.FORM._SELECT_ID_SELECTION.value = id;
  document.FORM.ARG_ID.value = id;
  document.FORM.submit();
}
</script>

<body>
<font face="arial,helvetica,sanserif">

<script>
document.writeln('<form method="POST" action="' + SELF + '" name="FORM">');
</script>
  <input type="hidden" name="ARG_ID" value="$ARG_ID">
  <input type="hidden" name="ARG_RULES">
  <input type="hidden" name="ARG_OPERATION" value="$ARG_OPERATION">
  <input type="hidden" name="_SELECT_ID_SELECTION" value="$_SELECT_ID_SELECTION">
  <input type="hidden" name="_USER_IDS_CHANGED" value="$_USER_IDS_CHANGED">
  <script>
    // Load dollarRESULT here to force dollarUSER_IDS to get updated.
    // Expect dollarRESULT to have double quotes escaped.
    RESULT="$RESULT";
    USER_IDS="$USER_IDS".split(";");
  </script>
  <table width="100%">
    <tr>
      <td width="10%">&nbsp;</td>
      <td width="80%" align="center"><strong><big><big><big>Transliteration Rule Editor</big></big></big></strong></td>
      <td width="10%" align="right"><a
      href="http://oss.software.ibm.com/icu/demo/translit_rule_help.html" target="_blank">Help</a></td>
    </tr>
  </table>
  <hr>
  <table width="100%">
    <tr>
      <td><table width="100%" cellspacing="0" cellpadding="0">
        <tr>
          <td width="97%">
          <select name="SELECT_ID" size="1" class="wide"
           onChange="handleSelectID()">
           <script>generateSelectIDOptions();</script>
          </select></td>
          <td width="1%">
          <input type="button" value="Save" onClick="handleSave()">
          </td>
          <td width="1%">
          <input type="button" value="Save As..." onClick="handleSaveAs()">
          </td>
          <td width="1%">
          <input type="button" value="Delete" onClick="handleDelete()">
          </td>
        </tr>
      </table>
      </td>
    </tr>
    <tr>
      <td><textarea name="RULE_SOURCE" rows="16" cols="20" class="wide">$RULE_SOURCE</textarea></td>
    </tr>
    <tr>
      <td><b>
        <script>document.write(RESULT);</script>
      </b></td>
    </tr>
  </table>
<input type="hidden" name="TEMPLATE_FILE" value="data/translit_rule_edit.html">
</form>

<script>
if (IS_NEW_ID) {
  document.FORM.RULE_SOURCE.value = "// Enter new rules here or select an existing rule above";
}

// If we have added or removed user IDs, we need to update the main window
if (document.FORM._USER_IDS_CHANGED.value) {
  window.opener.updateUserIDs(USER_IDS.join(";"));
  document.FORM._USER_IDS_CHANGED.value = "";
}
</script>

</font>

</body>
</html>
